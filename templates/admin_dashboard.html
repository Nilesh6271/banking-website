{% extends "base.html" %}

{% block title %}Admin Dashboard - Apex Bank{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.2s;
    }
    
    .dashboard-card:hover {
        transform: translateY(-2px);
    }
    
    .stats-card {
        border-left: 4px solid var(--primary-color);
    }
    
    .users-card {
        border-left: 4px solid var(--success-color);
    }
    
    .tokens-card {
        border-left: 4px solid var(--warning-color);
    }
    
    .atms-card {
        border-left: 4px solid var(--info-color);
    }
    
    .chart-container {
        height: 300px;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-tachometer-alt me-2"></i>Admin Dashboard</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
                        <i class="fas fa-user-plus me-1"></i>Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card dashboard-card">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                    <h5 class="card-title">Total Users</h5>
                    <h3 class="text-primary" id="totalUsers">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card tokens-card dashboard-card">
                <div class="card-body text-center">
                    <i class="fas fa-ticket-alt fa-2x text-warning mb-2"></i>
                    <h5 class="card-title">Total Tokens</h5>
                    <h3 class="text-warning" id="totalTokens">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card atms-card dashboard-card">
                <div class="card-body text-center">
                    <i class="fas fa-credit-card fa-2x text-info mb-2"></i>
                    <h5 class="card-title">ATMs</h5>
                    <h3 class="text-info" id="totalATMs">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card users-card dashboard-card">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                    <h5 class="card-title">Active Today</h5>
                    <h3 class="text-success" id="activeToday">0</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- User Management -->
        <div class="col-md-6">
            <div class="card users-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>User Management</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" onclick="filterUsers('all')">All</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="filterUsers('admin')">Admin</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="filterUsers('staff')">Staff</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="filterUsers('customer')">Customer</button>
                        </div>
                        <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Analytics -->
        <div class="col-md-6">
            <div class="card stats-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>System Analytics</h5>
                </div>
                <div class="card-body">
                    <div id="analyticsContent">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Activity</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Create New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="role" class="form-label">Role</label>
                                <select class="form-select" id="role" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="staff">Staff</option>
                                    <option value="customer">Customer</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3" id="accountNumberField" style="display: none;">
                        <label for="accountNumber" class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accountNumber">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createUser()">
                    <i class="fas fa-user-plus me-1"></i>Create User
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let dashboardData = null;
    let currentUserFilter = 'all';
    
    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
        loadUsers();
        loadRecentActivity();
        
        // Set up WebSocket listeners
        setupWebSocketListeners();
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadDashboardData();
            loadRecentActivity();
        }, 30000);
    });
    
    function loadDashboardData() {
        fetch(`${API_BASE}/api/admin/dashboard`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                dashboardData = data;
                updateDashboard(data);
            } else {
                showNotification('Failed to load dashboard data', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading dashboard:', error);
            showNotification('Connection error', 'error');
        });
    }
    
    function updateDashboard(data) {
        // Update statistics
        document.getElementById('totalUsers').textContent = data.statistics.users.total;
        document.getElementById('totalTokens').textContent = data.statistics.tokens.total;
        document.getElementById('totalATMs').textContent = data.statistics.atms.total;
        document.getElementById('activeToday').textContent = data.statistics.users.active;
        
        // Update analytics
        updateAnalytics(data.analytics);
    }
    
    function updateAnalytics(analytics) {
        const container = document.getElementById('analyticsContent');
        
        // Create a simple analytics display
        container.innerHTML = `
            <div class="row">
                <div class="col-6">
                    <div class="text-center">
                        <h6>Token Trends</h6>
                        <div class="small text-muted">
                            Daily: ${analytics.token_trends?.daily_counts?.length || 0} days
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="text-center">
                        <h6>Staff Performance</h6>
                        <div class="small text-muted">
                            Active: ${analytics.staff_performance?.length || 0} staff
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h6>Service Type Breakdown</h6>
                    <div class="small">
                        ${Object.entries(analytics.token_trends?.service_breakdown || {}).map(([type, count]) => 
                            `<div class="d-flex justify-content-between">
                                <span>${formatServiceType(type)}</span>
                                <span class="badge bg-primary">${count}</span>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    function loadUsers() {
        fetch(`${API_BASE}/api/admin/users?limit=10`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateUsersTable(data.users);
            } else {
                showNotification('Failed to load users', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
            showNotification('Connection error', 'error');
        });
    }
    
    function updateUsersTable(users) {
        const tbody = document.getElementById('usersTableBody');
        
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No users found</td></tr>';
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>
                    <div class="fw-bold">${user.full_name}</div>
                    <div class="small text-muted">${user.username}</div>
                </td>
                <td>
                    <span class="badge bg-${getRoleColor(user.role)}">${user.role.toUpperCase()}</span>
                </td>
                <td>
                    <span class="badge bg-${getStatusColor(user.status)}">${user.status.toUpperCase()}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser(${user.user_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.user_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    function loadRecentActivity() {
        fetch(`${API_BASE}/api/admin/system-logs?limit=10`, {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateRecentActivity(data.logs);
            } else {
                showNotification('Failed to load recent activity', 'error');
            }
        })
        .catch(error => {
            console.error('Error loading recent activity:', error);
            showNotification('Connection error', 'error');
        });
    }
    
    function updateRecentActivity(logs) {
        const tbody = document.getElementById('recentActivityBody');
        
        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No recent activity</td></tr>';
            return;
        }
        
        tbody.innerHTML = logs.map(log => `
            <tr>
                <td>${log.user_name || 'System'}</td>
                <td>
                    <span class="badge bg-info">${log.action}</span>
                </td>
                <td>${log.details || '-'}</td>
                <td>${formatDateTime(log.timestamp)}</td>
            </tr>
        `).join('');
    }
    
    function filterUsers(role) {
        currentUserFilter = role;
        loadUsers();
    }
    
    function createUser() {
        const formData = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            full_name: document.getElementById('fullName').value,
            role: document.getElementById('role').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value
        };
        
        // Add account number for customers
        if (formData.role === 'customer') {
            formData.account_number = document.getElementById('accountNumber').value;
        }
        
        fetch(`${API_BASE}/api/admin/users`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                document.getElementById('createUserForm').reset();
                loadUsers();
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error creating user:', error);
            showNotification('Failed to create user', 'error');
        });
    }
    
    function editUser(userId) {
        showNotification('Edit user functionality coming soon', 'info');
    }
    
    function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user?')) {
            return;
        }
        
        fetch(`${API_BASE}/api/admin/users/${userId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification(data.message, 'success');
                loadUsers();
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting user:', error);
            showNotification('Failed to delete user', 'error');
        });
    }
    
    function refreshData() {
        loadDashboardData();
        loadUsers();
        loadRecentActivity();
        showNotification('Data refreshed', 'success');
    }
    
    function setupWebSocketListeners() {
        socket.on('user_created', (data) => {
            showNotification(`New user created: ${data.user.full_name}`, 'info');
            loadUsers();
        });
        
        socket.on('user_updated', (data) => {
            showNotification(`User updated: ${data.user.full_name}`, 'info');
            loadUsers();
        });
        
        socket.on('token_generated', (data) => {
            showNotification(`New token generated: ${data.token.token_number}`, 'info');
            loadDashboardData();
        });
        
        socket.on('token_updated', (data) => {
            showNotification(`Token ${data.token.token_number} status updated`, 'info');
            loadDashboardData();
        });
        
        socket.on('atm_status_updated', (data) => {
            showNotification(`ATM ${data.atm.atm_name} status updated`, 'info');
            loadDashboardData();
        });
    }
    
    // Show/hide account number field based on role
    document.getElementById('role').addEventListener('change', function() {
        const accountNumberField = document.getElementById('accountNumberField');
        if (this.value === 'customer') {
            accountNumberField.style.display = 'block';
        } else {
            accountNumberField.style.display = 'none';
        }
    });
    
    // Utility functions
    function formatServiceType(serviceType) {
        const types = {
            'cash_deposit': 'Cash Deposit',
            'general_query': 'General Query',
            'loan_application': 'Loan Application',
            'meet_gm': 'Meet GM'
        };
        return types[serviceType] || serviceType;
    }
    
    function getRoleColor(role) {
        const colors = {
            'admin': 'danger',
            'staff': 'warning',
            'customer': 'info'
        };
        return colors[role] || 'secondary';
    }
    
    function getStatusColor(status) {
        const colors = {
            'active': 'success',
            'inactive': 'secondary',
            'suspended': 'danger'
        };
        return colors[status] || 'secondary';
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString();
    }
</script>
{% endblock %}
